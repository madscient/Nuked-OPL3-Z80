# Nuked-OPL3 z88dk移植 - TODOリスト

## フェーズ1: 基本構造の移植 ✓

- [x] プロジェクト構造の作成
- [x] README.mdの作成
- [x] PORTING.mdの作成
- [x] Makefileの作成
- [x] ヘッダーファイル(opl3.h)の作成
- [x] 64bit整数ヘルパー(opl3_int64.h)の作成
- [x] テストプログラムの作成

## フェーズ2: コア実装の移植 ⏳

### 2.1 オリジナルソースの取得と分析
- [x] 元のopl3.cをダウンロード
- [x] 元のopl3.hをダウンロード
- [x] コードの構造を分析
- [ ] 使用されているデータ型を確認
- [ ] 64bit演算が使われている箇所を特定

### 2.2 ルックアップテーブルの移植
- [x] logsinromテーブルを完全にコピー
- [x] expromテーブルを完全にコピー
- [x] その他の定数テーブルを移植
- [x] すべてのテーブルに`const`修飾子を追加(ROM配置)

### 2.3 基本関数の移植
- [x] OPL3_Reset() - 完全実装
  - [x] チップ構造体の初期化
  - [x] スロットの初期化
  - [x] チャンネルの初期化
  - [x] タイマーの初期化

- [ ] OPL3_WriteReg() - 完全実装
  - [ ] レジスタアドレスのデコード
  - [ ] 各レジスタタイプの処理
  - [ ] パラメータの更新

### 2.4 エンベロープジェネレータ
- [x] OPL3_EnvelopeCalc()
- [x] OPL3_EnvelopeUpdateKSL()
- [x] OPL3_EnvelopeCalcRate()
- [ ] エンベロープステートマシン

### 2.5 位相ジェネレータ
- [ ] OPL3_PhaseGenerate()
- [ ] OPL3_SlotCalcPhase()
- [ ] 波形選択の実装

### 2.6 オペレータ計算
- [ ] OPL3_SlotCalcFB()
- [ ] OPL3_SlotGenerate()
- [ ] モジュレーション計算

### 2.7 チャンネル計算
- [ ] OPL3_ChannelGenerate()
- [ ] アルゴリズム処理
- [ ] パンニング

### 2.8 サンプル生成
- [ ] OPL3_Generate() - 1サンプル生成
- [ ] OPL3_GenerateStream() - ストリーム生成
- [ ] OPL3_GenerateResampled() - リサンプリング

## フェーズ3: z88dk最適化 ⏳

### 3.1 データ型の最適化
- [ ] 64bit演算を32bit演算に置き換え可能な箇所を特定
- [ ] 不要な型キャストを削除
- [ ] メモリアラインメントの最適化

### 3.2 メモリ最適化
- [ ] 構造体のサイズ測定
- [ ] 不要なフィールドの削減
- [ ] データのパッキング
- [ ] スタック使用量の削減

### 3.3 速度最適化
- [ ] ホットスポットの特定(プロファイリング)
- [ ] 重要な関数のインライン化
- [ ] ループの最適化
- [ ] テーブルルックアップの活用

### 3.4 アセンブラ最適化(オプション)
- [ ] 乗算ルーチンのアセンブラ化
- [ ] シフト演算の最適化
- [ ] 64bit演算の最適化

## フェーズ4: テストとデバッグ ⏳

### 4.1 単体テスト
- [ ] チップ初期化のテスト
- [ ] レジスタ書き込みのテスト
- [ ] 各オペレータのテスト
- [ ] エンベロープのテスト
- [ ] 波形生成のテスト

### 4.2 統合テスト
- [ ] 単音の再生テスト
- [ ] 和音の再生テスト
- [ ] リズムモードのテスト
- [ ] 音色切り替えのテスト

### 4.3 プラットフォーム別テスト
- [ ] ZX Spectrumでのテスト
- [ ] MSXでのテスト
- [ ] CP/Mでのテスト
- [ ] Amstrad CPCでのテスト

### 4.4 パフォーマンステスト
- [ ] サンプル生成速度の測定
- [ ] CPU使用率の測定
- [ ] メモリ使用量の測定
- [ ] リアルタイム性の確認

## フェーズ5: ドキュメントとサンプル ⏳

### 5.1 ドキュメント
- [ ] APIリファレンスの作成
- [ ] 使用例の追加
- [ ] トラブルシューティングガイド
- [ ] パフォーマンスチューニングガイド

### 5.2 サンプルプログラム
- [ ] simple_test.c - 基本動作確認
- [ ] scale_demo.c - 音階演奏
- [ ] instrument_demo.c - 音色デモ
- [ ] rhythm_demo.c - リズムモードデモ
- [ ] imf_player.c - IMFファイル再生(オプション)

### 5.3 ツール
- [ ] レジスタダンプツール
- [ ] 音色エディタ(オプション)
- [ ] パフォーマンスプロファイラ

## フェーズ6: リリース準備 ⏳

- [ ] すべてのコンパイル警告の解決
- [ ] コードレビュー
- [ ] ライセンス表記の確認
- [ ] バージョン番号の設定
- [ ] リリースノートの作成
- [ ] GitHubリポジトリの公開

## 優先順位付け

### 高優先度(必須)
1. オリジナルソースの完全移植
2. 基本的なサンプル生成機能
3. ZX Spectrumでの動作確認

### 中優先度(推奨)
1. パフォーマンス最適化
2. 他プラットフォームへの対応
3. サンプルプログラムの充実

### 低優先度(オプション)
1. アセンブラ最適化
2. 追加ツールの開発
3. 高度なサンプルプログラム

## 既知の課題

### 技術的制約
- z88dkの64bit整数サポート不足
- 限られたRAM容量(ZX Spectrum 48Kなど)
- 低速なCPU(3.5MHz程度)

### 移植上の懸念
- リアルタイム再生のパフォーマンス
- 浮動小数点演算の有無(確認必要)
- エンディアンの違い(Z80はリトルエンディアン)

## 参考資料

- オリジナルプロジェクト: https://github.com/nukeykt/Nuked-OPL3
- z88dk Wiki: https://github.com/z88dk/z88dk/wiki
- OPL3仕様書: https://www.fit.vutbr.cz/~arnost/opl/opl3.html
- Z80命令セット: http://www.z80.info/z80code.htm

## 進捗状況

| フェーズ | 完了率 | 状態 |
|---------|--------|------|
| 1. 基本構造 | 100% | ✓ 完了 |
| 2. コア実装 | 5% | ⏳ 作業中 |
| 3. 最適化 | 0% | ⏳ 未着手 |
| 4. テスト | 0% | ⏳ 未着手 |
| 5. ドキュメント | 20% | ⏳ 作業中 |
| 6. リリース | 0% | ⏳ 未着手 |

**全体進捗: 約15%**
